<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vibha Agro Dairy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: calc(var(--radius) - 2px);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }

        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }

        .btn-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .btn-destructive:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }

        .btn-sm {
            height: 2.25rem;
            padding: 0 0.75rem;
            font-size: 0.875rem;
        }

        .btn-md {
            height: 2.5rem;
            padding: 0 1rem;
        }

        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
        }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: calc(var(--radius) - 4px);
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-danger {
            background-color: #ef4444;
            color: white;
        }

        .animate-in {
            animation: animateIn 0.5s ease-out;
        }

        @keyframes animateIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hover-lift {
            transition: transform 0.2s ease-in-out;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Modern Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="images/vadf.png" alt="Vibha Agro Dairy Logo" class="h-10 w-auto">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Vibha Agro Dairy</h1>
                    <p class="text-sm text-gray-600">Admin Panel</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <a href="/" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <a href="bills.html" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-file-invoice mr-2"></i>Bills
                </a>
                <button onclick="logout()" class="text-gray-700 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Admin Header -->
        <div class="text-center mb-8 animate-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Admin Dashboard</h2>
            <p class="text-gray-600">Manage your dairy business operations</p>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 hover-lift">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Orders</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-orders">0</p>
                    </div>
                </div>
            </div>

            <div class="card p-6 hover-lift">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-revenue">$0.00</p>
                    </div>
                </div>
            </div>

            <div class="card p-6 hover-lift">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Customers</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-customers">0</p>
                    </div>
                </div>
            </div>

            <div class="card p-6 hover-lift">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Products</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-products">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button class="tab-btn active text-blue-600 border-blue-600" data-tab="dashboard">Dashboard</button>
                    <button class="tab-btn text-gray-500" data-tab="inventory">Inventory</button>
                    <button class="tab-btn text-gray-500" data-tab="orders">Orders</button>
                    <button class="tab-btn text-gray-500" data-tab="bills">Bills</button>
                    <button class="tab-btn text-gray-500" data-tab="customers">Customers</button>
                    <button class="tab-btn text-gray-500" data-tab="users">Users</button>
                    <button class="tab-btn text-gray-500" data-tab="analytics">Analytics</button>
                    <button class="tab-btn text-gray-500" data-tab="investments">Investments</button>
                    <button class="tab-btn text-gray-500" data-tab="expenses">Expenses</button>
                    <button class="tab-btn text-gray-500" data-tab="backups">Backups</button>
                </nav>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active p-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Recent Orders</h3>
                        <div id="recent-orders" class="space-y-3">
                            <!-- Recent orders will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">Low Stock Items</h3>
                        <div id="low-stock-items" class="space-y-3">
                            <!-- Low stock items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory" class="tab-content hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Inventory Management</h3>
                    <button onclick="addProduct()" class="btn btn-primary btn-md">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Product
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table" class="bg-white divide-y divide-gray-200">
                            <!-- Inventory items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Order Management</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Manage customer orders and their status</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-3"><input type="checkbox" id="select-all-orders" /></th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="orders-table">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bills Tab -->
            <div id="bills" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Bill Management</h2>
                    <button onclick="generateNewBill()" class="btn btn-primary">Generate New Bill</button>
                </div>
                <div id="bills-content">
                    <p class="text-gray-500">Loading bills...</p>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4">Customer Analytics & Newsletter</h2>
                    
                    <!-- Customer Stats Cards -->
                    <div class="grid md:grid-cols-4 gap-6 mb-8">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Customers</p>
                                    <p id="total-customers" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Repeat Customers</p>
                                    <p id="repeat-customers" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">New This Month</p>
                                    <p id="new-customers" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Newsletter Subs</p>
                                    <p id="newsletter-subs" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Customers Table -->
                    <div class="card mb-8">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">Top Customers by Revenue</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Orders</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Spent</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Order</th>
                                    </tr>
                                </thead>
                                <tbody id="top-customers-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Newsletter Subscribers -->
                    <div class="card">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Newsletter Subscribers</h3>
                            <button onclick="exportNewsletterSubscribers()" class="btn btn-secondary btn-sm">Export CSV</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscribed Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="newsletter-subscribers-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content hidden">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">User Management</h2>
                        <button onclick="showAddUserModal()" class="btn btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add New User
                        </button>
                    </div>
                    
                    <!-- User Stats Cards -->
                    <div class="grid md:grid-cols-4 gap-6 mb-8">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Users</p>
                                    <p id="total-users" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Admins</p>
                                    <p id="total-admins" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Customers</p>
                                    <p id="total-customers-users" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Active Users</p>
                                    <p id="active-users" class="text-2xl font-bold">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="card">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">All Users</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Profitability Overview -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-semibold">Profitability Overview</h2>
                            <select id="analytics-period" class="form-select" onchange="loadAnalytics()">
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div id="profitability-stats" class="grid grid-cols-2 gap-4 mb-6">
                                <!-- Stats will be loaded here -->
                            </div>
                            <div id="sales-chart" class="h-64">
                                <!-- Chart will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Top Products -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-semibold">Top Products</h2>
                        </div>
                        <div class="card-body">
                            <div id="top-products" class="space-y-3">
                                <!-- Top products will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Expense Categories -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-semibold">Expense Categories</h2>
                        </div>
                        <div class="card-body">
                            <div id="expense-categories" class="space-y-3">
                                <!-- Expense categories will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Investment Categories -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-semibold">Investment Categories</h2>
                        </div>
                        <div class="card-body">
                            <div id="investment-categories" class="space-y-3">
                                <!-- Investment categories will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investments Tab -->
            <div id="investments-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-xl font-semibold">Investment Management</h2>
                        <button onclick="showAddInvestmentModal()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add Investment
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="investments-list" class="space-y-4">
                            <!-- Investments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-xl font-semibold">Expense Management</h2>
                        <button onclick="showAddExpenseModal()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add Expense
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="expenses-list" class="space-y-4">
                            <!-- Expenses will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backups Tab -->
            <div id="backups-tab" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-xl font-semibold">Backup Management</h2>
                        <button onclick="createBackup()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Create Backup
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="backups-list" class="space-y-4">
                            <!-- Backups will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let orders = [];
        let inventory = [];

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin panel initializing...');
            checkAuth();
            loadDashboardData();
            setupTabNavigation();
        });

        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
        }

        function setupTabNavigation() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    
                    // Update button states
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500');
                    });
                    btn.classList.add('active', 'text-blue-600', 'border-blue-600');
                    btn.classList.remove('text-gray-500');
                    
                    // Update content visibility
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName).classList.remove('hidden');
                    document.getElementById(tabName).classList.add('active');
                    
                    // Load data for the selected tab
                    if (tabName === 'inventory') {
                        console.log('Loading inventory tab...');
                        loadInventory();
                    } else if (tabName === 'orders') {
                        console.log('Loading orders tab...');
                        loadOrders();
                    } else if (tabName === 'bills') {
                        console.log('Loading bills tab...');
                        loadBills();
                    } else if (tabName === 'customers') {
                        console.log('Loading customers tab...');
                        loadCustomers();
                    } else if (tabName === 'users') {
                        console.log('Loading users tab...');
                        loadUsers();
                    } else if (tabName === 'analytics') {
                        console.log('Loading analytics tab...');
                        loadAnalytics();
                    } else if (tabName === 'investments') {
                        console.log('Loading investments tab...');
                        loadInvestments();
                    } else if (tabName === 'expenses') {
                        console.log('Loading expenses tab...');
                        loadExpenses();
                    } else if (tabName === 'backups') {
                        console.log('Loading backups tab...');
                        loadBackups();
                    }
                });
            });
        }

        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                const [ordersRes, inventoryRes, productsRes] = await Promise.all([
                    fetch('/api/orders'),
                    fetch('/api/inventory'),
                    fetch('/api/products')
                ]);
                
                orders = await ordersRes.json();
                const inventoryData = await inventoryRes.json();
                const productsData = await productsRes.json();
                
                // Merge inventory and products data
                inventory = inventoryData.map(invItem => {
                    const product = productsData.find(p => p.id === invItem.productId);
                    return {
                        ...invItem,
                        name: product ? product.name : 'Unknown Product',
                        price: product ? product.price : 0,
                        description: product ? product.description : '',
                        image: product ? product.image.replace('/images/', '') : 'cattle1.jpg'
                    };
                });
                
                console.log('Dashboard data loaded - Orders:', orders.length, 'Inventory:', inventory.length);
                
                updateDashboardStats();
                loadRecentOrders();
                loadLowStockItems();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateDashboardStats() {
            document.getElementById('total-orders').textContent = orders.length;
            document.getElementById('total-revenue').textContent = '₹' + orders.reduce((sum, order) => sum + order.total, 0).toFixed(2);
            document.getElementById('total-customers').textContent = new Set(orders.map(order => order.customerId)).size;
            document.getElementById('total-products').textContent = inventory.length;
        }

        function loadRecentOrders() {
            const recentOrders = orders.slice(-5).reverse();
            const container = document.getElementById('recent-orders');
            
            container.innerHTML = recentOrders.map(order => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium">Order #${order.id}</p>
                        <p class="text-sm text-gray-600">${order.customerName}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium">₹${order.total.toFixed(2)}</p>
                        <span class="badge badge-${order.status === 'completed' ? 'success' : order.status === 'cancelled' ? 'danger' : 'warning'}">${order.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function loadLowStockItems() {
            const lowStock = inventory.filter(item => (item.stock || item.quantity || 0) < 20);
            const container = document.getElementById('low-stock-items');
            
            if (lowStock.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No low stock items</p>';
                return;
            }
            
            container.innerHTML = lowStock.map(item => `
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                    <div>
                        <p class="font-medium">${item.name || 'Unknown Product'}</p>
                        <p class="text-sm text-gray-600">Stock: ${item.stock || item.quantity || 0}</p>
                    </div>
                    <button onclick="promptUpdateStock(${item.id}, ${item.stock || item.quantity || 0})" class="btn btn-primary btn-sm">Update</button>
                </div>
            `).join('');
        }

        function promptUpdateStock(productId, currentStock) {
            const newStock = prompt('Enter new stock value:', currentStock);
            if (newStock !== null && !isNaN(newStock) && newStock !== "") {
                updateStock(productId, parseInt(newStock));
            }
        }

        async function loadInventory() {
            try {
                const [inventoryResponse, productsResponse] = await Promise.all([
                    fetch('/api/inventory'),
                    fetch('/api/products')
                ]);
                
                const inventoryData = await inventoryResponse.json();
                const productsData = await productsResponse.json();
                
                // Merge inventory and products data
                const mergedInventory = inventoryData.map(invItem => {
                    const product = productsData.find(p => p.id === invItem.productId);
                    return {
                        ...invItem,
                        name: product ? product.name : 'Unknown Product',
                        price: product ? product.price : 0,
                        description: product ? product.description : '',
                        image: product ? product.image.replace('/images/', '') : 'cattle1.jpg'
                    };
                });
                
                inventory = mergedInventory;
                
                const tbody = document.getElementById('inventory-table');
                tbody.innerHTML = mergedInventory.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="/images/${item.image}" alt="${item.name}" class="h-10 w-10 rounded-lg object-cover">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${item.name}</div>
                                    <div class="text-sm text-gray-500">₹${item.price.toFixed(2)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="number" value="${item.stock || item.quantity || 0}" min="0" 
                                   onchange="updateStock(${item.id}, this.value)" 
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm ${(item.stock || item.quantity || 0) < 20 ? 'border-red-300 bg-red-50' : ''}">
                            ${(item.stock || item.quantity || 0) < 20 ? '<span class="text-xs text-red-600 ml-1">Low</span>' : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editProduct(${item.id})" class="btn btn-secondary btn-sm mr-2">Edit</button>
                            <button onclick="deleteProduct(${item.id})" class="btn btn-destructive btn-sm">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        async function loadOrders() {
            try {
                console.log('Loading orders...');
                const response = await fetch('/api/orders');
                orders = await response.json();
                console.log('Orders loaded:', orders);
                
                const tbody = document.getElementById('orders-table');
                console.log('Orders table element:', tbody);
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No orders found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td class="px-2 py-4"><input type="checkbox" class="order-checkbox" data-order-id="${order.id}" /></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${order.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.customerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.items.length} items</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${order.total.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge badge-${order.status === 'completed' ? 'success' : order.status === 'cancelled' ? 'danger' : 'warning'}">${order.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openUpdateOrderStatusModal(${order.id}, '${order.status}')" class="btn btn-primary btn-sm">Update</button>
                        </td>
                    </tr>
                `).join('');
                
                // Setup select all and bulk update
                const selectAllCheckbox = document.getElementById('select-all-orders');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', function() {
                        const checked = this.checked;
                        document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = checked);
                        toggleBulkUpdateButton();
                    });
                }
                
                document.querySelectorAll('.order-checkbox').forEach(cb => {
                    cb.addEventListener('change', toggleBulkUpdateButton);
                });
                toggleBulkUpdateButton();
                console.log('Orders table updated');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function toggleBulkUpdateButton() {
            let btn = document.getElementById('bulk-update-status-btn');
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'bulk-update-status-btn';
                btn.className = 'btn btn-warning mb-4';
                btn.textContent = 'Bulk Update Status';
                btn.style.display = 'none';
                btn.onclick = openBulkUpdateOrderStatusModal;
                const ordersTab = document.getElementById('orders');
                if (ordersTab) {
                    ordersTab.insertBefore(btn, ordersTab.firstChild);
                }
            }
            const anyChecked = Array.from(document.querySelectorAll('.order-checkbox')).some(cb => cb.checked);
            btn.style.display = anyChecked ? 'inline-block' : 'none';
        }

        function getSelectedOrderIds() {
            return Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));
        }

        function openUpdateOrderStatusModal(orderId, currentStatus) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Update Order Status</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select id="order-status-select" class="form-select w-full">
                            <option value="pending" ${currentStatus === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${currentStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="confirmUpdateOrderStatus(${orderId})">Update</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmUpdateOrderStatus(orderId) {
            const modal = document.querySelector('.fixed');
            const newStatus = document.getElementById('order-status-select').value;
            await updateOrderStatus(orderId, newStatus);
            if (modal) modal.remove();
        }

        function openBulkUpdateOrderStatusModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Bulk Update Order Status</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select id="bulk-order-status-select" class="form-select w-full">
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="confirmBulkUpdateOrderStatus()">Update</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmBulkUpdateOrderStatus() {
            const modal = document.querySelector('.fixed');
            const newStatus = document.getElementById('bulk-order-status-select').value;
            const orderIds = getSelectedOrderIds();
            for (const orderId of orderIds) {
                await updateOrderStatus(orderId, newStatus, false);
            }
            if (modal) modal.remove();
            loadOrders();
        }

        async function updateOrderStatus(orderId, newStatus, showAlert = true) {
            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (response.ok) {
                    if (showAlert) alert('Order status updated successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                if (showAlert) alert('Error updating order status: ' + error.message);
            }
        }

        async function loadBills() {
            try {
                const response = await fetch('/api/bills');
                const bills = await response.json();
                
                const tbody = document.getElementById('bills-table');
                tbody.innerHTML = bills.map(bill => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bill.billId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">#${bill.orderId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bill.customerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${bill.total.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(bill.createdAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewBill(${bill.orderId})" class="btn btn-primary btn-sm mr-2">View</button>
                            <button onclick="generateBill(${bill.orderId})" class="btn btn-success btn-sm mr-2">Generate</button>
                            <button onclick="downloadPDF(${bill.orderId})" class="btn btn-warning btn-sm">PDF</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading bills:', error);
            }
        }

        async function updateStock(productId, newStock) {
            try {
                console.log(`Updating stock for product ${productId} to ${newStock}`);
                
                const response = await fetch(`/api/inventory/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ stock: parseInt(newStock) })
                });

                if (response.ok) {
                    const updatedItem = await response.json();
                    console.log('Stock updated successfully:', updatedItem);
                    
                    // Update the local inventory array
                    const index = inventory.findIndex(item => item.id === productId);
                    if (index !== -1) {
                        inventory[index] = updatedItem;
                    }
                    
                    // Refresh the inventory display
                    loadInventory();
                    
                    // Refresh dashboard data
                    loadDashboardData();
                    
                    alert('Stock updated successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update stock');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                alert('Error updating stock: ' + error.message);
            }
        }

        function addProduct() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Add New Product</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="add-product-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Product Name *</label>
                            <input type="text" name="name" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Price (₹) *</label>
                            <input type="number" name="price" step="0.01" min="0" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Initial Stock *</label>
                            <input type="number" name="stock" min="0" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" class="form-textarea w-full" rows="3" placeholder="Product description..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Image</label>
                            <select name="image" class="form-select w-full">
                                <option value="cattle1.jpg">Cattle 1</option>
                                <option value="cattle2.jpg">Cattle 2</option>
                                <option value="cattle3.jpg">Cattle 3</option>
                                <option value="check.jpg">Check</option>
                                <option value="check1.jpg">Check 1</option>
                                <option value="check2.jpg">Check 2</option>
                                <option value="check_1.jpg">Check 1 Alt</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Product</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            modal.querySelector('#add-product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch('/api/inventory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`Product "${result.product.name}" added successfully!`);
                        modal.remove();
                        loadInventory(); // Refresh the inventory table
                        loadDashboardData(); // Refresh dashboard stats
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to add product');
                    }
                } catch (error) {
                    console.error('Error adding product:', error);
                    alert('Error adding product: ' + error.message);
                }
            });
        }

        function editProduct(productId) {
            const item = inventory.find(item => item.id === productId);
            if (!item) {
                alert('Product not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Edit Product</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="edit-product-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Product Name *</label>
                            <input type="text" name="name" value="${item.name}" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Price (₹) *</label>
                            <input type="number" name="price" step="0.01" min="0" value="${item.price}" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Stock *</label>
                            <input type="number" name="stock" min="0" value="${item.stock || item.quantity || 0}" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" class="form-textarea w-full" rows="3" placeholder="Product description...">${item.description || ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Image</label>
                            <select name="image" class="form-select w-full">
                                <option value="/images/cattle1.jpg" ${item.image === 'cattle1.jpg' ? 'selected' : ''}>Cattle 1</option>
                                <option value="/images/cattle2.jpg" ${item.image === 'cattle2.jpg' ? 'selected' : ''}>Cattle 2</option>
                                <option value="/images/cattle3.jpg" ${item.image === 'cattle3.jpg' ? 'selected' : ''}>Cattle 3</option>
                                <option value="/images/check.jpg" ${item.image === 'check.jpg' ? 'selected' : ''}>Check</option>
                                <option value="/images/check1.jpg" ${item.image === 'check1.jpg' ? 'selected' : ''}>Check 1</option>
                                <option value="/images/check2.jpg" ${item.image === 'check2.jpg' ? 'selected' : ''}>Check 2</option>
                                <option value="/images/check_1.jpg" ${item.image === 'check_1.jpg' ? 'selected' : ''}>Check 1 Alt</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            modal.querySelector('#edit-product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch(`/api/inventory/${productId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`Product "${result.product.name}" updated successfully!`);
                        modal.remove();
                        loadInventory(); // Refresh the inventory table
                        loadDashboardData(); // Refresh dashboard stats
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update product');
                    }
                } catch (error) {
                    console.error('Error updating product:', error);
                    alert('Error updating product: ' + error.message);
                }
            });
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/inventory/${productId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Product deleted successfully!');
                    loadInventory(); // Refresh the inventory table
                    loadDashboardData(); // Refresh dashboard stats
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete product');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product: ' + error.message);
            }
        }

        function viewOrder(orderId) {
            // Implementation for viewing order details
            alert('View order functionality would be implemented here');
        }

        function filterOrders(status) {
            // Implementation for filtering orders
            alert('Filter orders functionality would be implemented here');
        }

        async function viewBill(orderId) {
            try {
                const response = await fetch(`/api/bills/${orderId}`);
                const bill = await response.json();
                
                // Create a simple modal to display bill
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                modal.innerHTML = `
                    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Bill Preview</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-center mb-4">${bill.companyInfo.name}</h4>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <p><strong>Bill ID:</strong> ${bill.billId}</p>
                                        <p><strong>Customer:</strong> ${bill.customerName}</p>
                                    </div>
                                    <div>
                                        <p><strong>Date:</strong> ${new Date(bill.billDate).toLocaleDateString()}</p>
                                        <p><strong>Total:</strong> ₹${bill.total.toFixed(2)}</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button onclick="generateBill(${orderId})" class="btn btn-primary mr-2">Generate Bill</button>
                                    <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading bill:', error);
                alert('Error loading bill');
            }
        }

        async function generateBill(orderId) {
            try {
                // First mark the bill as printed
                const printResponse = await fetch(`/api/bills/${orderId}/print`, {
                    method: 'POST'
                });
                
                if (!printResponse.ok) {
                    throw new Error('Failed to mark bill as printed');
                }
                
                // Generate and download PDF
                const pdfResponse = await fetch(`/api/bills/${orderId}/pdf`);
                
                if (pdfResponse.ok) {
                    const blob = await pdfResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BILL-${orderId.toString().padStart(4, '0')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('PDF bill generated and downloaded successfully!');
                } else {
                    throw new Error('Failed to generate PDF');
                }
                
                // Close any open modals
                const modals = document.querySelectorAll('.fixed');
                modals.forEach(modal => modal.remove());
                
                // Refresh the bills list
                loadBills();
                
            } catch (error) {
                console.error('Error generating bill:', error);
                alert('Error generating bill: ' + error.message);
            }
        }

        async function downloadPDF(orderId) {
            try {
                const response = await fetch(`/api/bills/${orderId}/pdf`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BILL-${orderId.toString().padStart(4, '0')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('PDF bill downloaded successfully!');
                } else {
                    throw new Error('Failed to generate PDF');
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Load analytics data
        async function loadAnalytics() {
            const period = document.getElementById('analytics-period').value;
            try {
                const response = await fetch(`/api/analytics/profitability?period=${period}`);
                const data = await response.json();
                
                // Update profitability stats
                const statsContainer = document.getElementById('profitability-stats');
                statsContainer.innerHTML = `
                    <div class="stat-card bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-600">₹${data.revenue.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">Revenue</div>
                    </div>
                    <div class="stat-card bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-2xl font-bold text-red-600">₹${data.expenses.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">Expenses</div>
                    </div>
                    <div class="stat-card bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-600">₹${data.profit.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">Profit</div>
                    </div>
                    <div class="stat-card bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-600">${data.profitMargin.toFixed(1)}%</div>
                        <div class="text-sm text-gray-600">Profit Margin</div>
                    </div>
                `;
                
                // Update top products
                const topProductsContainer = document.getElementById('top-products');
                topProductsContainer.innerHTML = data.topProducts.map((product, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-gray-400 mr-3">${index + 1}</span>
                            <div>
                                <div class="font-semibold">${product.name}</div>
                                <div class="text-sm text-gray-600">₹${product.sales.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Update expense categories
                const expenseCategoriesContainer = document.getElementById('expense-categories');
                expenseCategoriesContainer.innerHTML = data.expenseCategories.map(category => `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                        <div class="font-semibold">${category.category}</div>
                        <div class="text-red-600 font-bold">₹${category.amount.toFixed(2)}</div>
                    </div>
                `).join('');
                
                // Update investment categories
                const investmentCategoriesContainer = document.getElementById('investment-categories');
                investmentCategoriesContainer.innerHTML = data.investmentCategories.map(category => `
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <div class="font-semibold">${category.category}</div>
                        <div class="text-blue-600 font-bold">₹${category.amount.toFixed(2)}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Investment management functions
        async function loadInvestments() {
            try {
                const response = await fetch('/api/investments');
                const investments = await response.json();
                
                const container = document.getElementById('investments-list');
                container.innerHTML = investments.map(investment => `
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                        <div>
                            <div class="font-semibold">${investment.title}</div>
                            <div class="text-sm text-gray-600">${investment.description}</div>
                            <div class="text-xs text-gray-500">${investment.category} • ${new Date(investment.date).toLocaleDateString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-blue-600">₹${investment.amount.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading investments:', error);
            }
        }

        function showAddInvestmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Add Investment</h3>
                    <form id="investment-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Title</label>
                            <input type="text" name="title" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Amount (₹)</label>
                            <input type="number" name="amount" step="0.01" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Category</label>
                            <select name="category" class="form-select w-full" required>
                                <option value="Equipment">Equipment</option>
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Technology">Technology</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" class="form-textarea w-full" rows="3"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Date</label>
                            <input type="date" name="date" class="form-input w-full" required>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Investment</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date
            modal.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];
            
            // Handle form submission
            modal.querySelector('#investment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch('/api/investments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        modal.remove();
                        loadInvestments();
                        loadAnalytics();
                    }
                } catch (error) {
                    console.error('Error adding investment:', error);
                }
            });
        }

        // Expense management functions
        async function loadExpenses() {
            try {
                const response = await fetch('/api/expenses');
                const expenses = await response.json();
                
                const container = document.getElementById('expenses-list');
                container.innerHTML = expenses.map(expense => `
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                        <div>
                            <div class="font-semibold">${expense.title}</div>
                            <div class="text-sm text-gray-600">${expense.description}</div>
                            <div class="text-xs text-gray-500">${expense.category} • ${new Date(expense.date).toLocaleDateString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-red-600">₹${expense.amount.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        function showAddExpenseModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Add Expense</h3>
                    <form id="expense-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Title</label>
                            <input type="text" name="title" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Amount (₹)</label>
                            <input type="number" name="amount" step="0.01" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Category</label>
                            <select name="category" class="form-select w-full" required>
                                <option value="Feed">Feed</option>
                                <option value="Veterinary">Veterinary</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Labor">Labor</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" class="form-textarea w-full" rows="3"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Date</label>
                            <input type="date" name="date" class="form-input w-full" required>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Expense</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date
            modal.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];
            
            // Handle form submission
            modal.querySelector('#expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch('/api/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        modal.remove();
                        loadExpenses();
                        loadAnalytics();
                    }
                } catch (error) {
                    console.error('Error adding expense:', error);
                }
            });
        }

        // Backup management functions
        async function loadBackups() {
            try {
                const response = await fetch('/api/backups');
                const backups = await response.json();
                
                const backupsList = document.getElementById('backups-list');
                if (backups.length === 0) {
                    backupsList.innerHTML = '<p class="text-gray-500 text-center py-8">No backups found.</p>';
                    return;
                }
                
                backupsList.innerHTML = backups.map(backup => `
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 last:border-b-0">
                        <div>
                            <h4 class="font-semibold">${backup.name}</h4>
                            <p class="text-sm text-gray-500">Created: ${new Date(backup.createdAt).toLocaleString()}</p>
                            <p class="text-sm text-gray-500">Size: ${backup.size}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="restoreBackup('${backup.name}')" class="btn btn-secondary btn-sm">Restore</button>
                            <button onclick="downloadBackup('${backup.name}')" class="btn btn-outline btn-sm">Download</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading backups:', error);
            }
        }

        async function createBackup() {
            try {
                const response = await fetch('/api/backups/create', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    alert('Backup created successfully!');
                    loadBackups();
                } else {
                    alert('Error creating backup: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('Error creating backup');
            }
        }

        async function restoreBackup(backupName) {
            if (!confirm(`Are you sure you want to restore from backup "${backupName}"? This will overwrite current data.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backups/restore/${backupName}`, { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    alert('Backup restored successfully!');
                    location.reload(); // Reload page to refresh all data
                } else {
                    alert('Error restoring backup: ' + result.error);
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('Error restoring backup');
            }
        }

        async function deleteBackup(backupName) {
            if (!confirm(`Are you sure you want to delete backup "${backupName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backups/${backupName}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (response.ok) {
                    alert('Backup deleted successfully!');
                    loadBackups();
                } else {
                    alert('Error deleting backup: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting backup:', error);
                alert('Error deleting backup');
            }
        }

        // Customer management functions
        async function loadCustomers() {
            try {
                const response = await fetch('/api/analytics/enhanced');
                const analytics = await response.json();
                
                // Update customer stats
                document.getElementById('total-customers').textContent = analytics.totalCustomers;
                document.getElementById('repeat-customers').textContent = analytics.repeatCustomers;
                document.getElementById('new-customers').textContent = analytics.newCustomersThisMonth;
                document.getElementById('newsletter-subs').textContent = analytics.newsletterStats.totalSubscribers;
                
                // Load top customers table
                const topCustomersTable = document.getElementById('top-customers-table');
                if (analytics.topCustomers.length === 0) {
                    topCustomersTable.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No customer data available</td></tr>';
                } else {
                    topCustomersTable.innerHTML = analytics.topCustomers.map(customer => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${customer.customerName}</div>
                                <div class="text-sm text-gray-500">ID: ${customer.customerId}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.totalOrders}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${customer.totalSpent.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.lastOrder ? new Date(customer.lastOrder).toLocaleDateString() : 'N/A'}</td>
                        </tr>
                    `).join('');
                }
                
                // Load newsletter subscribers
                await loadNewsletterSubscribers();
                
            } catch (error) {
                console.error('Error loading customer data:', error);
            }
        }

        async function loadNewsletterSubscribers() {
            try {
                const response = await fetch('/api/newsletter/subscribers');
                const subscribers = await response.json();
                
                const subscribersTable = document.getElementById('newsletter-subscribers-table');
                if (subscribers.length === 0) {
                    subscribersTable.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No newsletter subscribers found</td></tr>';
                    return;
                }
                
                subscribersTable.innerHTML = subscribers.map(sub => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sub.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(sub.subscribedAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge ${sub.active ? 'badge-success' : 'badge-danger'}">${sub.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="toggleNewsletterStatus(${sub.id})" class="btn btn-sm ${sub.active ? 'btn-destructive' : 'btn-success'}">
                                ${sub.active ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading newsletter subscribers:', error);
            }
        }

        async function toggleNewsletterStatus(subscriberId) {
            if (!confirm('Are you sure you want to change this subscriber\'s status?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/newsletter/subscribers/${subscriberId}/toggle`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadNewsletterSubscribers();
                } else {
                    alert('Failed to update subscriber status');
                }
            } catch (error) {
                console.error('Error toggling newsletter status:', error);
                alert('Error updating subscriber status');
            }
        }

        function exportNewsletterSubscribers() {
            // This would typically call a backend endpoint to generate and download a CSV
            alert('Export functionality would generate a CSV file with all newsletter subscribers');
        }

        // User management functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                
                // Update user stats
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('total-admins').textContent = users.filter(u => u.role === 'admin').length;
                document.getElementById('total-customers-users').textContent = users.filter(u => u.role === 'customer').length;
                document.getElementById('active-users').textContent = users.filter(u => u.active !== false).length;
                
                // Load users table
                const usersTable = document.getElementById('users-table');
                if (users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                    return;
                }
                
                usersTable.innerHTML = users.map(user => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">${user.role}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="badge ${user.active !== false ? 'badge-success' : 'badge-danger'}">${user.active !== false ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser(${user.id})" class="btn btn-secondary btn-sm mr-2">Edit</button>
                            <button onclick="toggleUserStatus(${user.id})" class="btn btn-sm ${user.active !== false ? 'btn-warning' : 'btn-success'} mr-2">
                                ${user.active !== false ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deleteUser(${user.id})" class="btn btn-destructive btn-sm">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold mb-4">Add New User</h3>
                    <form id="add-user-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Username</label>
                            <input type="text" name="username" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" name="password" class="form-input w-full" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Role</label>
                            <select name="role" class="form-select w-full" required>
                                <option value="">Select Role</option>
                                <option value="customer">Customer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add User</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            modal.querySelector('#add-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        modal.remove();
                        loadUsers();
                        alert('User created successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error creating user: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error creating user:', error);
                    alert('Error creating user');
                }
            });
        }

        async function editUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                const user = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Edit User</h3>
                        <form id="edit-user-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Username</label>
                                <input type="text" name="username" value="${user.username}" class="form-input w-full" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Password (leave blank to keep current)</label>
                                <input type="password" name="password" class="form-input w-full" placeholder="New password">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Role</label>
                                <select name="role" class="form-select w-full" required>
                                    <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Customer</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" name="active" ${user.active !== false ? 'checked' : ''} class="mr-2">
                                    <span class="text-sm font-medium">Active</span>
                                </label>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update User</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                modal.querySelector('#edit-user-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    
                    // Handle checkbox
                    data.active = formData.has('active');
                    
                    // Remove empty password
                    if (!data.password) {
                        delete data.password;
                    }
                    
                    try {
                        const response = await fetch(`/api/users/${userId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        
                        if (response.ok) {
                            modal.remove();
                            loadUsers();
                            alert('User updated successfully!');
                        } else {
                            const error = await response.json();
                            alert('Error updating user: ' + error.error);
                        }
                    } catch (error) {
                        console.error('Error updating user:', error);
                        alert('Error updating user');
                    }
                });
            } catch (error) {
                console.error('Error loading user for edit:', error);
                alert('Error loading user data');
            }
        }

        async function toggleUserStatus(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                const user = await response.json();
                
                const newStatus = !user.active;
                const statusText = newStatus ? 'activate' : 'deactivate';
                
                if (!confirm(`Are you sure you want to ${statusText} user "${user.username}"?`)) {
                    return;
                }
                
                const updateResponse = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: newStatus })
                });
                
                if (updateResponse.ok) {
                    loadUsers();
                    alert(`User ${statusText}d successfully!`);
                } else {
                    const error = await updateResponse.json();
                    alert('Error updating user: ' + error.error);
                }
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error updating user status');
            }
        }

        async function deleteUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                const user = await response.json();
                
                if (!confirm(`Are you sure you want to delete user "${user.username}"? This action cannot be undone.`)) {
                    return;
                }
                
                const deleteResponse = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (deleteResponse.ok) {
                    loadUsers();
                    alert('User deleted successfully!');
                } else {
                    const error = await deleteResponse.json();
                    alert('Error deleting user: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }
    </script>
</body>
</html> 