<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vibha Agro Dairy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: calc(var(--radius) - 2px);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }

        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }

        .btn-destructive {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .btn-destructive:hover {
            background-color: hsl(var(--destructive) / 0.9);
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-outline {
            border-color: hsl(var(--input));
            background-color: transparent;
            color: hsl(var(--foreground));
        }

        .btn-sm {
            height: 2.25rem;
            padding: 0 0.75rem;
            font-size: 0.875rem;
        }

        .btn-md {
            height: 2.5rem;
            padding: 0 1rem;
        }

        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
        }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: calc(var(--radius) - 4px);
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-danger {
            background-color: #ef4444;
            color: white;
        }

        .animate-in {
            animation: animateIn 0.5s ease-out;
        }

        @keyframes animateIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hover-lift {
            transition: transform 0.2s ease-in-out;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: hsl(var(--muted-foreground));
        }

        .form-checkbox {
            width: 1rem;
            height: 1rem;
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 4px);
            background-color: hsl(var(--background));
            transition: background-color 0.2s, border-color 0.2s;
        }

        .form-checkbox:checked {
            background-color: hsl(var(--primary));
            border-color: hsl(var(--primary));
        }

        .form-checkbox:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Modern Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="images/vadf.png" alt="Vibha Agro Dairy Logo" class="h-10 w-auto">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Vibha Agro Dairy</h1>
                    <p class="text-sm text-gray-600">Admin Control Panel</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button onclick="viewSystemStatus()" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-server mr-2"></i>System Status
                </button>
                <button onclick="viewAuditLogs()" class="text-gray-700 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-history mr-2"></i>Audit Logs
                </button>
                <button onclick="viewSettings()" class="text-gray-700 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <button onclick="logout()" class="text-gray-700 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Admin Header -->
        <div class="text-center mb-8 animate-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Admin Dashboard</h2>
            <p class="text-gray-600">Manage your dairy business operations</p>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <button onclick="runMonthlyBillCycle()" class="btn btn-primary p-4 text-left flex items-center space-x-3">
                <i class="fas fa-sync text-2xl"></i>
                <span>Run Bill Cycle</span>
            </button>
            <button onclick="broadcastAnnouncement()" class="btn btn-warning p-4 text-left flex items-center space-x-3">
                <i class="fas fa-bullhorn text-2xl"></i>
                <span>Broadcast Message</span>
            </button>
            <button onclick="generateReports()" class="btn btn-success p-4 text-left flex items-center space-x-3">
                <i class="fas fa-chart-bar text-2xl"></i>
                <span>Generate Reports</span>
            </button>
            <button onclick="manageUsers()" class="btn btn-secondary p-4 text-left flex items-center space-x-3">
                <i class="fas fa-users text-2xl"></i>
                <span>Manage Users</span>
            </button>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Revenue</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="totalRevenue">â‚¹0.00</h3>
                    </div>
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-500" id="revenueChange">+0% from last month</span>
                </div>
            </div>
            <div class="card p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Orders</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="activeOrders">0</h3>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-500" id="orderChange">0 pending delivery</span>
                </div>
            </div>
            <div class="card p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Low Stock Items</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="lowStockCount">0</h3>
                    </div>
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-500" id="stockAlert">All stock levels normal</span>
                </div>
            </div>
            <div class="card p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Users</p>
                        <h3 class="text-2xl font-bold text-gray-800" id="activeUsers">0</h3>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-users text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-sm text-gray-500" id="userChange">0 new this month</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="grid md:grid-cols-3 gap-6">
            <!-- Business Management Section -->
            <div class="md:col-span-2 space-y-6">
                <!-- Inventory Management -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Inventory Management</h3>
                        <button onclick="addProduct()" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add Product
                        </button>
                    </div>
                    <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Product
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Stock
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Price
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Inventory items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Recent Transactions</h3>
                        <button onclick="viewAllTransactions()" class="btn btn-secondary btn-sm">View All</button>
                    </div>
                    <div class="space-y-4" id="recentTransactions">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="space-y-6">
                <!-- System Controls -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">System Controls</h3>
                    <div class="space-y-4">
                        <button onclick="backupSystem()" class="btn btn-secondary w-full text-left flex items-center justify-between">
                            <span><i class="fas fa-database mr-2"></i>Backup System</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button onclick="manageWallets()" class="btn btn-secondary w-full text-left flex items-center justify-between">
                            <span><i class="fas fa-wallet mr-2"></i>Manage Wallets</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button onclick="viewLogs()" class="btn btn-secondary w-full text-left flex items-center justify-between">
                            <span><i class="fas fa-list mr-2"></i>View System Logs</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Announcements -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Recent Announcements</h3>
                    <div class="space-y-4" id="recentAnnouncements">
                        <!-- Announcements will be loaded here -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Quick Stats</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-600">Monthly Revenue Target</p>
                            <div class="flex items-center mt-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 70%"></div>
                                </div>
                                <span class="ml-2 text-sm font-medium text-gray-600">70%</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Customer Satisfaction</p>
                            <div class="flex items-center mt-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="ml-2 text-sm font-medium text-gray-600">85%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/your-font-awesome-kit.js"></script>
    <script>
        // Initialize data
        let inventory = [];
        let systemMetrics = {};
        let auditLogs = [];
        let systemSettings = {};
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadInventory();
            loadSystemMetrics();
            loadAuditLogs();
            loadSettings();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                // Update dashboard stats
                document.getElementById('totalRevenue').textContent = `â‚¹${data.revenue.toFixed(2)}`;
                document.getElementById('activeOrders').textContent = data.activeOrders;
                document.getElementById('lowStockCount').textContent = data.lowStockItems;
                document.getElementById('activeUsers').textContent = data.activeUsers;
                
                // Update changes
                document.getElementById('revenueChange').textContent = `${data.revenueChange}% from last month`;
                document.getElementById('orderChange').textContent = `${data.pendingDeliveries} pending delivery`;
                document.getElementById('stockAlert').textContent = data.lowStockItems > 0 ? 
                    `${data.lowStockItems} items need attention` : 'All stock levels normal';
                document.getElementById('userChange').textContent = `${data.newUsers} new this month`;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function runMonthlyBillCycle() {
            if (!confirm('Are you sure you want to run the monthly bill cycle? This will generate bills for all customers.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/billing/run-cycle', { method: 'POST' });
                const result = await response.json();
                alert(`Bill cycle completed successfully! Generated ${result.billCount} bills.`);
                loadDashboardData();
            } catch (error) {
                console.error('Error running bill cycle:', error);
                alert('Failed to run bill cycle. Please check the logs.');
            }
        }

        async function broadcastAnnouncement() {
            const message = prompt('Enter your announcement message:');
            if (!message) return;
            
            try {
                const response = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    alert('Announcement broadcast successfully!');
                    loadAnnouncements();
                } else {
                    throw new Error('Failed to broadcast announcement');
                }
            } catch (error) {
                console.error('Error broadcasting announcement:', error);
                alert('Failed to broadcast announcement');
            }
        }

        async function generateReports() {
            const reportTypes = ['sales', 'inventory', 'customers', 'financial'];
            const type = prompt(`Select report type (${reportTypes.join(', ')}):`);
            
            if (!type || !reportTypes.includes(type.toLowerCase())) {
                alert('Invalid report type');
                return;
            }
            
            try {
                const response = await fetch(`/api/reports/${type}`, { method: 'POST' });
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}-report.pdf`;
                a.click();
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report');
            }
        }

        async function backupSystem() {
            try {
                const response = await fetch('/api/system/backup', { method: 'POST' });
                const result = await response.json();
                alert(`Backup created successfully! Location: ${result.backupPath}`);
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('Failed to create backup');
            }
        }

        async function manageWallets() {
            try {
                const response = await fetch('/api/wallets');
                const wallets = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Wallet Management</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Transaction</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${wallets.map(wallet => `
                                        <tr>
                                            <td class="px-6 py-4">${wallet.userName}</td>
                                            <td class="px-6 py-4">â‚¹${wallet.balance.toFixed(2)}</td>
                                            <td class="px-6 py-4">${new Date(wallet.lastTransaction).toLocaleDateString()}</td>
                                            <td class="px-6 py-4">
                                                <button onclick="adjustWalletBalance('${wallet.userId}')" class="btn btn-sm btn-secondary mr-2">
                                                    Adjust Balance
                                                </button>
                                                <button onclick="viewWalletHistory('${wallet.userId}')" class="btn btn-sm btn-outline">
                                                    View History
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading wallets:', error);
                alert('Failed to load wallet data');
            }
        }

        async function adjustWalletBalance(userId) {
            const amount = prompt('Enter adjustment amount (use negative for deduction):');
            if (!amount) return;
            
            try {
                const response = await fetch(`/api/wallets/${userId}/adjust`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount) })
                });
                
                if (response.ok) {
                    alert('Wallet balance adjusted successfully!');
                    manageWallets(); // Refresh the wallet management modal
                } else {
                    throw new Error('Failed to adjust wallet balance');
                }
            } catch (error) {
                console.error('Error adjusting wallet balance:', error);
                alert('Failed to adjust wallet balance');
            }
        }

        async function viewWalletHistory(userId) {
            try {
                const response = await fetch(`/api/wallets/${userId}/history`);
                const history = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Wallet Transaction History</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${history.map(transaction => `
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium">${transaction.type}</p>
                                        <p class="text-sm text-gray-600">${new Date(transaction.date).toLocaleString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${transaction.amount > 0 ? '+' : ''}â‚¹${transaction.amount.toFixed(2)}
                                        </p>
                                        <p class="text-sm text-gray-600">Balance: â‚¹${transaction.balance.toFixed(2)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading wallet history:', error);
                alert('Failed to load wallet history');
            }
        }

        async function viewLogs() {
            try {
                const response = await fetch('/api/system/logs');
                const logs = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">System Logs</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${logs.map(log => `
                                <div class="p-3 rounded ${log.level === 'error' ? 'bg-red-50 text-red-700' : 
                                    log.level === 'warning' ? 'bg-yellow-50 text-yellow-700' : 'bg-gray-50 text-gray-700'}">
                                    <div class="flex items-center">
                                        <span class="font-medium">[${log.level.toUpperCase()}]</span>
                                        <span class="mx-2">-</span>
                                        <span>${new Date(log.timestamp).toLocaleString()}</span>
                                    </div>
                                    <p class="mt-1">${log.message}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading system logs:', error);
                alert('Failed to load system logs');
            }
        }

        async function manageUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">User Management</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="mb-4">
                            <button onclick="addUser()" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus mr-2"></i>Add User
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${users.map(user => `
                                        <tr>
                                            <td class="px-6 py-4">${user.name}</td>
                                            <td class="px-6 py-4">${user.email}</td>
                                            <td class="px-6 py-4">
                                                <span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">
                                                    ${user.role}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">
                                                    ${user.active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <button onclick="editUser('${user.id}')" class="btn btn-sm btn-secondary mr-2">
                                                    Edit
                                                </button>
                                                <button onclick="toggleUserStatus('${user.id}')" class="btn btn-sm ${user.active ? 'btn-destructive' : 'btn-success'}">
                                                    ${user.active ? 'Deactivate' : 'Activate'}
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load user data');
            }
        }

        async function viewSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const status = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold">System Status</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">Server Health</h4>
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full ${status.health === 'good' ? 'bg-green-500' : 'bg-red-500'} mr-2"></div>
                                        <span>${status.health.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">CPU Usage</h4>
                                    <div class="flex items-center">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${status.cpuUsage}%"></div>
                                        </div>
                                        <span class="ml-2">${status.cpuUsage}%</span>
                                    </div>
                                </div>
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">Memory Usage</h4>
                                    <div class="flex items-center">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-purple-500 h-2 rounded-full" style="width: ${status.memoryUsage}%"></div>
                                        </div>
                                        <span class="ml-2">${status.memoryUsage}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">Active Connections</h4>
                                    <p class="text-2xl font-bold">${status.activeConnections}</p>
                                </div>
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">Last Backup</h4>
                                    <p>${new Date(status.lastBackup).toLocaleString()}</p>
                                </div>
                                <div class="card p-4">
                                    <h4 class="font-medium mb-2">System Uptime</h4>
                                    <p>${status.uptime}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button onclick="runSystemMaintenance()" class="btn btn-primary">
                                <i class="fas fa-tools mr-2"></i>Run Maintenance
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading system status:', error);
                alert('Failed to load system status');
            }
        }

        async function viewAuditLogs() {
            try {
                const response = await fetch('/api/system/audit-logs');
                const logs = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold">Audit Logs</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${logs.map(log => `
                                <div class="card p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="font-medium">${log.action}</span>
                                            <span class="mx-2">by</span>
                                            <span class="text-blue-600">${log.user}</span>
                                        </div>
                                        <span class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</span>
                                    </div>
                                    <p class="text-gray-600">${log.details}</p>
                                    ${log.changes ? `
                                        <div class="mt-2 text-sm">
                                            <div class="text-red-600">- ${log.changes.old}</div>
                                            <div class="text-green-600">+ ${log.changes.new}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-6 flex justify-between">
                            <button onclick="exportAuditLogs()" class="btn btn-secondary">
                                <i class="fas fa-download mr-2"></i>Export Logs
                            </button>
                            <button onclick="clearAuditLogs()" class="btn btn-destructive">
                                <i class="fas fa-trash mr-2"></i>Clear Logs
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading audit logs:', error);
                alert('Failed to load audit logs');
            }
        }

        async function viewSettings() {
            try {
                const response = await fetch('/api/system/settings');
                const settings = await response.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold">System Settings</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="settingsForm" class="space-y-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Automatic Backup Schedule</label>
                                    <select name="backupSchedule" class="form-select w-full" value="${settings.backupSchedule}">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Low Stock Threshold</label>
                                    <input type="number" name="lowStockThreshold" class="form-input w-full" 
                                        value="${settings.lowStockThreshold}" min="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Bill Generation Day</label>
                                    <input type="number" name="billGenerationDay" class="form-input w-full" 
                                        value="${settings.billGenerationDay}" min="1" max="28">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">System Maintenance Window</label>
                                    <input type="time" name="maintenanceTime" class="form-input w-full" 
                                        value="${settings.maintenanceTime}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email Notifications</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="notifyLowStock" class="form-checkbox" 
                                                ${settings.notifications.lowStock ? 'checked' : ''}>
                                            <span class="ml-2">Low Stock Alerts</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="notifySystemErrors" class="form-checkbox" 
                                                ${settings.notifications.systemErrors ? 'checked' : ''}>
                                            <span class="ml-2">System Error Alerts</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="notifyNewOrders" class="form-checkbox" 
                                                ${settings.notifications.newOrders ? 'checked' : ''}>
                                            <span class="ml-2">New Order Notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                const form = modal.querySelector('#settingsForm');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const settings = {
                        backupSchedule: formData.get('backupSchedule'),
                        lowStockThreshold: parseInt(formData.get('lowStockThreshold')),
                        billGenerationDay: parseInt(formData.get('billGenerationDay')),
                        maintenanceTime: formData.get('maintenanceTime'),
                        notifications: {
                            lowStock: formData.get('notifyLowStock') === 'on',
                            systemErrors: formData.get('notifySystemErrors') === 'on',
                            newOrders: formData.get('notifyNewOrders') === 'on'
                        }
                    };
                    
                    try {
                        const response = await fetch('/api/system/settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settings)
                        });
                        
                        if (response.ok) {
                            alert('Settings updated successfully!');
                            modal.remove();
                        } else {
                            throw new Error('Failed to update settings');
                        }
                    } catch (error) {
                        console.error('Error updating settings:', error);
                        alert('Failed to update settings');
                    }
                });
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Failed to load settings');
            }
        }

        async function runSystemMaintenance() {
            if (!confirm('Are you sure you want to run system maintenance? This may cause temporary system downtime.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/system/maintenance', { method: 'POST' });
                const result = await response.json();
                alert(`Maintenance completed successfully!\n\nOptimized ${result.optimizedTables} tables\nCleaned up ${result.cleanedRecords} old records\nUpdated ${result.updatedIndexes} indexes`);
            } catch (error) {
                console.error('Error running maintenance:', error);
                alert('Failed to run system maintenance');
            }
        }

        async function exportAuditLogs() {
            try {
                const response = await fetch('/api/system/audit-logs/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'audit-logs.csv';
                a.click();
            } catch (error) {
                console.error('Error exporting audit logs:', error);
                alert('Failed to export audit logs');
            }
        }

        async function clearAuditLogs() {
            if (!confirm('Are you sure you want to clear all audit logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                await fetch('/api/system/audit-logs', { method: 'DELETE' });
                alert('Audit logs cleared successfully!');
                viewAuditLogs(); // Refresh the audit logs view
            } catch (error) {
                console.error('Error clearing audit logs:', error);
                alert('Failed to clear audit logs');
            }
        }

        // Inventory Management Functions
        async function loadInventory() {
            try {
                const [inventoryResponse, productsResponse] = await Promise.all([
                    fetch('/api/inventory'),
                    fetch('/api/products')
                ]);
                
                const inventory = await inventoryResponse.json();
                const products = await productsResponse.json();
                
                // Combine inventory and product data
                const inventoryData = inventory.map(item => {
                    const product = products.find(p => p.id === item.productId) || {};
                    return {
                        ...item,
                        name: product.name,
                        price: product.price,
                        description: product.description,
                        image: product.image
                    };
                });
                
                // Update inventory table
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = inventoryData.map(item => `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <img src="${item.image}" alt="${item.name}" class="h-10 w-10 rounded-full mr-3">
                                <div>
                                    <div class="font-medium text-gray-900">${item.name}</div>
                                    <div class="text-sm text-gray-500">${item.description || 'No description'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-medium">${item.stock}</span>
                            ${item.stock <= 10 ? '<span class="ml-2 badge badge-warning">Low Stock</span>' : ''}
                        </td>
                        <td class="px-6 py-4">â‚¹${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="badge ${item.stock > 0 ? 'badge-success' : 'badge-danger'}">
                                ${item.stock > 0 ? 'In Stock' : 'Out of Stock'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="editProduct(${item.id})" class="btn btn-sm btn-secondary mr-2">
                                Edit
                            </button>
                            <button onclick="deleteProduct(${item.id})" class="btn btn-sm btn-destructive">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading inventory:', error);
                alert('Failed to load inventory');
            }
        }

        async function addProduct() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Add New Product</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="addProductForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Product Name</label>
                            <input type="text" name="name" required class="form-input w-full" placeholder="Enter product name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Price</label>
                            <input type="number" name="price" required class="form-input w-full" min="0" step="0.01" placeholder="Enter price">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Initial Stock</label>
                            <input type="number" name="stock" required class="form-input w-full" min="0" placeholder="Enter initial stock">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" class="form-textarea w-full" rows="3" placeholder="Enter product description"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Image URL</label>
                            <input type="text" name="image" class="form-input w-full" placeholder="Enter image URL">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Add Product
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const form = modal.querySelector('#addProductForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const productData = {
                    name: formData.get('name'),
                    price: parseFloat(formData.get('price')),
                    stock: parseInt(formData.get('stock')),
                    description: formData.get('description'),
                    image: formData.get('image') || '/images/cattle1.jpg'
                };
                
                try {
                    const response = await fetch('/api/inventory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                    
                    if (response.ok) {
                        alert('Product added successfully!');
                        modal.remove();
                        loadInventory(); // Refresh inventory table
                        loadDashboardData(); // Refresh dashboard stats
                    } else {
                        throw new Error('Failed to add product');
                    }
                } catch (error) {
                    console.error('Error adding product:', error);
                    alert('Failed to add product');
                }
            });
        }

        async function editProduct(id) {
            try {
                const [inventoryResponse, productsResponse] = await Promise.all([
                    fetch('/api/inventory'),
                    fetch('/api/products')
                ]);
                
                const inventory = await inventoryResponse.json();
                const products = await productsResponse.json();
                
                const item = inventory.find(i => i.id === id);
                const product = products.find(p => p.id === item.productId);
                
                if (!item || !product) {
                    alert('Product not found');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Edit Product</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="editProductForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Product Name</label>
                                <input type="text" name="name" required class="form-input w-full" value="${product.name}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Price</label>
                                <input type="number" name="price" required class="form-input w-full" min="0" step="0.01" value="${product.price}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Stock</label>
                                <input type="number" name="stock" required class="form-input w-full" min="0" value="${item.stock}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" class="form-textarea w-full" rows="3">${product.description || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Image URL</label>
                                <input type="text" name="image" class="form-input w-full" value="${product.image}">
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const form = modal.querySelector('#editProductForm');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const productData = {
                        name: formData.get('name'),
                        price: parseFloat(formData.get('price')),
                        stock: parseInt(formData.get('stock')),
                        description: formData.get('description'),
                        image: formData.get('image')
                    };
                    
                    try {
                        const response = await fetch(`/api/inventory/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(productData)
                        });
                        
                        if (response.ok) {
                            alert('Product updated successfully!');
                            modal.remove();
                            loadInventory(); // Refresh inventory table
                            loadDashboardData(); // Refresh dashboard stats
                        } else {
                            throw new Error('Failed to update product');
                        }
                    } catch (error) {
                        console.error('Error updating product:', error);
                        alert('Failed to update product');
                    }
                });
            } catch (error) {
                console.error('Error loading product details:', error);
                alert('Failed to load product details');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/inventory/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Product deleted successfully!');
                    loadInventory(); // Refresh inventory table
                    loadDashboardData(); // Refresh dashboard stats
                } else {
                    throw new Error('Failed to delete product');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product');
            }
        }
    </script>
</body>
</html> 